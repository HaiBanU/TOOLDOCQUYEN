<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Qu·∫£n L√Ω Game</title>
    <link rel="stylesheet" href="/css/global.css">
    <link rel="stylesheet" href="/css/admin.css">
    <link rel="manifest" href="/manifest.json">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
</head>
<script>
    // === B·∫ÆT BU·ªòC KI·ªÇM TRA ƒêƒÇNG NH·∫¨P ===
    if (!localStorage.getItem('username')) {
        window.location.href = '/'; // Chuy·ªÉn v·ªÅ trang ƒëƒÉng nh·∫≠p
    }
</script>
<body class="admin-page">
    <div id="toast-container"></div>

    <header class="header fadeIn">
        <a href="/admin.html" class="back-button">&larr; Quay l·∫°i Menu</a>
        <div class="header-right-group">
            <div id="admin-coin-display">Token: ...</div>
            <button class="logout-button">
                 <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                <span>ƒêƒÉng Xu·∫•t</span>
            </button>
        </div>
    </header>

    <main class="fadeIn" style="animation-delay: 0.2s;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h2 style="margin-top:0;">Qu·∫£n L√Ω S·∫£nh Game</h2>
            <div>
                <button id="save-order-btn" class="btn-primary" style="display: none; width: auto; padding: 12px 20px; margin-right: 15px; background: #28a745;">L∆∞u Th·ª© T·ª±</button>
                <button class="btn-primary" style="width: auto; padding: 12px 20px;" onclick="openAddLobbyModal()">T·∫°o S·∫£nh M·ªõi</button>
            </div>
        </div>
        <div id="lobby-container" class="grid-container" style="margin-top: 20px; cursor: grab;"></div>
    </main>

    <div id="addLobbyModal" class="modal">
        <div class="modal-content fadeIn">
            <span class="close-btn" onclick="closeModals()">&times;</span>
            <h2>T·∫°o S·∫£nh Game M·ªõi</h2>
            <form id="add-lobby-form">
                <div class="form-group"><input type="text" name="name" placeholder="T√™n S·∫£nh" required></div>
                
                <!-- === C·∫¨P NH·∫¨T: Th√™m tr∆∞·ªùng ch·ªçn Lo·∫°i S·∫£nh === -->
                <div class="form-group">
                    <label style="display: block; margin-bottom: 5px; text-align: left;">Lo·∫°i S·∫£nh</label>
                    <select name="category" class="form-control" required style="padding: 12px; border: 1px solid #ccc; border-radius: 8px; width: 100%;">
                        <option value="nohu">N·ªï H≈©</option>
                        <option value="banca">B·∫Øn C√°</option>
                    </select>
                </div>
                <!-- ======================================= -->

                <div class="form-group">
                    <label style="display: block; margin-bottom: 5px; text-align: left;">Logo S·∫£nh (Khuy·∫øn kh√≠ch ·∫£nh GIF)</label>
                    <input type="file" name="logo" accept="image/gif, image/jpeg, image/png" required>
                </div>
                <button type="submit" class="btn-primary">T·∫°o S·∫£nh</button>
            </form>
             <div id="modal-message" class="modal-alert"></div>
        </div>
    </div>

    <div id="editLobbyModal" class="modal">
        <div class="modal-content fadeIn">
            <span class="close-btn" onclick="closeModals()">&times;</span>
            <h2 id="edit-lobby-title">Ch·ªânh S·ª≠a S·∫£nh</h2>
            <form id="edit-lobby-form">
                <input type="hidden" name="lobby_id" id="edit-lobby-id">
                
                <div class="form-group" style="text-align: center;">
                    <label>Logo Hi·ªán T·∫°i</label>
                    <img id="current-lobby-logo" src="" style="max-width: 150px; max-height: 80px; margin-top: 10px; border: 1px solid #ddd; padding: 5px; border-radius: 8px;">
                </div>

                <div class="form-group">
                    <label>Ch·ªçn Logo M·ªõi</label>
                    <input type="file" name="logo" accept="image/gif, image/jpeg, image/png" required>
                </div>
                <button type="submit" class="btn-primary">L∆∞u Thay ƒê·ªïi</button>
            </form>
             <div id="edit-modal-message" class="modal-alert"></div>
        </div>
    </div>
    
    <script>
        const lobbyContainer = document.getElementById('lobby-container');
        const addLobbyModal = document.getElementById('addLobbyModal');
        const addLobbyForm = document.getElementById('add-lobby-form');
        const saveOrderBtn = document.getElementById('save-order-btn');
        const modalMessageEl = document.getElementById('modal-message');
        
        const editLobbyModal = document.getElementById('editLobbyModal');
        const editLobbyForm = document.getElementById('edit-lobby-form');
        const editModalMessageEl = document.getElementById('edit-modal-message');
        
        let sortableInstance = null;

        function showToast(message, isSuccess = true) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${isSuccess ? 'success' : 'error'}`;
            const iconSVG = isSuccess 
                ? `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"></path></svg>`
                : `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.47 2 2 6.47 2 12s4.47 10 10 10 10-4.47 10-10S17.53 2 12 2zm4.3 14.3a.996.996 0 01-1.41 0L12 13.41l-2.89 2.89a.996.996 0 11-1.41-1.41L10.59 12 7.7 9.11a.996.996 0 111.41-1.41L12 10.59l2.89-2.89a.996.996 0 111.41 1.41L13.41 12l2.89 2.89c.38.38.38 1.02 0 1.41z"></path></svg>`;
            toast.innerHTML = `<span class="toast-icon">${iconSVG}</span><span class="toast-message">${message}</span>`;
            container.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => {
                toast.classList.add('hide');
                toast.addEventListener('transitionend', () => toast.remove());
            }, 4000);
        }

        function showModalMessage(message, isSuccess, modalType = 'add') {
            const el = modalType === 'add' ? modalMessageEl : editModalMessageEl;
            el.classList.remove('show', 'modal-alert-success', 'modal-alert-error');
            if (!message) return;
            el.textContent = message;
            el.classList.add('show', isSuccess ? 'modal-alert-success' : 'modal-alert-error');
        }

        function openAddLobbyModal() { 
            showModalMessage('', true, 'add');
            addLobbyModal.style.display = 'flex'; 
        }

        function openEditLobbyModal(lobbyId, lobbyName, currentLogoUrl) {
            showModalMessage('', true, 'edit');
            document.getElementById('edit-lobby-id').value = lobbyId;
            document.getElementById('edit-lobby-title').textContent = `Ch·ªânh S·ª≠a S·∫£nh "${lobbyName}"`;
            document.getElementById('current-lobby-logo').src = currentLogoUrl;
            editLobbyModal.style.display = 'flex';
        }

        function closeModals() { 
            addLobbyModal.style.display = 'none'; 
            editLobbyModal.style.display = 'none';
        }
        
        // === C·∫¨P NH·∫¨T: To√†n b·ªô h√†m fetchAndDisplayLobbies ƒë·ªÉ ph√¢n nh√≥m ===
        async function fetchAndDisplayLobbies() {
            // Fetch t·∫•t c·∫£ c√°c s·∫£nh, kh√¥ng l·ªçc
            const response = await fetch('/api/lobbies');
            const data = await response.json();
            lobbyContainer.innerHTML = '';

            if (data.success && data.lobbies.length > 0) {
                // Nh√≥m c√°c s·∫£nh theo category
                const groupedLobbies = data.lobbies.reduce((acc, lobby) => {
                    const category = lobby.category || 'nohu'; // M·∫∑c ƒë·ªãnh l√† n·ªï h≈© n·∫øu kh√¥ng c√≥
                    if (!acc[category]) {
                        acc[category] = [];
                    }
                    acc[category].push(lobby);
                    return acc;
                }, {});

                const renderLobbyGroup = (title, lobbies) => {
                    const groupTitle = document.createElement('h3');
                    groupTitle.textContent = title;
                    groupTitle.style.cssText = "grid-column: 1 / -1; margin-top: 20px; border-bottom: 2px solid #e9ecef; padding-bottom: 10px; color: #333;";
                    lobbyContainer.appendChild(groupTitle);

                    lobbies.forEach(lobby => {
                        const cardWrapper = document.createElement('div');
                        cardWrapper.className = 'card';
                        cardWrapper.dataset.id = lobby._id;
                        
                        cardWrapper.innerHTML = `
                            <a href="/admin_manage_lobby.html?id=${lobby._id}&name=${encodeURIComponent(lobby.name)}" style="text-decoration: none; color: inherit; display: block;">
                                <h3>${lobby.name}</h3>
                                <img src="${lobby.logo_url}" style="width: 100px; height: 50px; object-fit: contain;" loading="lazy">
                                <p style="margin-top: 10px; font-size: 0.8em; color: #888;">Nh·∫•n ƒë·ªÉ qu·∫£n l√Ω game</p>
                            </a>
                            <button class="btn-primary" style="width: 100%; margin-top: 15px; background: #5a6268;" 
                                    onclick="event.preventDefault(); openEditLobbyModal('${lobby._id}', '${lobby.name}', '${lobby.logo_url}')">
                                S·ª≠a S·∫£nh
                            </button>
                        `;
                        lobbyContainer.appendChild(cardWrapper);
                    });
                };

                // Hi·ªÉn th·ªã nh√≥m N·ªï H≈© tr∆∞·ªõc n·∫øu c√≥
                if (groupedLobbies.nohu) {
                    renderLobbyGroup('üé∞ S·∫£nh N·ªï H≈©', groupedLobbies.nohu);
                }
                // Hi·ªÉn th·ªã nh√≥m B·∫Øn C√° n·∫øu c√≥
                if (groupedLobbies.banca) {
                    renderLobbyGroup('üê† S·∫£nh B·∫Øn C√°', groupedLobbies.banca);
                }

                if (!sortableInstance) {
                    sortableInstance = new Sortable(lobbyContainer, {
                        animation: 150,
                        ghostClass: 'sortable-ghost',
                        onEnd: function() { saveOrderBtn.style.display = 'inline-block'; }
                    });
                }
            } else {
                 lobbyContainer.innerHTML = `<p style="text-align:center; color: #888; grid-column: 1 / -1;">Ch∆∞a c√≥ s·∫£nh n√†o.</p>`
            }
        }

        addLobbyForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const button = e.target.querySelector('button[type="submit"]');
            button.classList.add('btn-loading');
            showModalMessage('', true, 'add');
            const formData = new FormData(addLobbyForm);
            try {
                const response = await fetch('/api/add-lobby', { method: 'POST', body: formData });
                const result = await response.json();
                if (result.success) {
                    showToast(result.message, true);
                    addLobbyForm.reset();
                    closeModals();
                    fetchAndDisplayLobbies();
                } else {
                    showModalMessage(result.message, false, 'add');
                }
            } catch (error) {
                showModalMessage('L·ªói k·∫øt n·ªëi m√°y ch·ªß!', false, 'add');
            } finally {
                button.classList.remove('btn-loading');
            }
        });
        
        editLobbyForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const button = e.target.querySelector('button[type="submit"]');
            button.classList.add('btn-loading');
            showModalMessage('', true, 'edit');

            const formData = new FormData(editLobbyForm);
            try {
                const response = await fetch('/api/update-lobby', { 
                    method: 'POST', 
                    body: formData 
                });
                const result = await response.json();
                
                if (result.success) {
                    showToast(result.message, true);
                    editLobbyForm.reset();
                    closeModals();
                    fetchAndDisplayLobbies();
                } else {
                    showModalMessage(result.message, false, 'edit');
                }
            } catch (error) {
                showModalMessage('L·ªói k·∫øt n·ªëi m√°y ch·ªß!', false, 'edit');
            } finally {
                button.classList.remove('btn-loading');
            }
        });
        
        saveOrderBtn.addEventListener('click', async () => {
            if (!sortableInstance) return;
            const orderedIds = sortableInstance.toArray();
            saveOrderBtn.classList.add('btn-loading');
            try {
                const response = await fetch('/api/update-lobby-order', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ orderedIds })
                });
                const result = await response.json();
                showToast(result.message, result.success);
                if (result.success) {
                    saveOrderBtn.style.display = 'none';
                }
            } catch (error) {
                showToast('L·ªói k·∫øt n·ªëi m√°y ch·ªß!', false);
            } finally {
                saveOrderBtn.classList.remove('btn-loading');
            }
        });
        
        document.querySelector('.logout-button').addEventListener('click', () => {
            localStorage.clear();
            window.location.href = '/';
        });
        
        async function fetchAdminInfo() {
            const username = localStorage.getItem('username');
            const coinDisplay = document.getElementById('admin-coin-display');
            if (localStorage.getItem('isSuperAdmin') === 'true' || !coinDisplay) {
                if(coinDisplay) coinDisplay.style.display = 'none';
                return;
            }
            const response = await fetch(`/api/user-info?username=${username}`);
            const data = await response.json();
            if (data.success) {
                coinDisplay.textContent = `Token c√≤n l·∫°i: ${data.userInfo.coins}`;
            }
        }

        window.onclick = (event) => { 
            if (event.target == addLobbyModal || event.target == editLobbyModal) {
                closeModals();
            }
        }
        window.onload = () => { fetchAndDisplayLobbies(); fetchAdminInfo(); };
    </script>
    <script src="/js/global.js"></script>
</body>
</html>