<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IronxSlot</title>
    <link rel="icon" type="image/png" href="/assets/images/favicon.png">
    <link rel="stylesheet" href="/css/global.css">
    <link rel="stylesheet" href="/css/login.css">
    <link rel="manifest" href="/manifest.json">
</head>
<body class="full-page">
    <canvas id="matrix-canvas"></canvas>
    
    <!-- Các góc trang trí -->
    <div class="digital-frame-corner corner-tl"></div>
    <div class="digital-frame-corner corner-tr"></div>
    <div class="digital-frame-corner corner-bl"></div>
    <div class="digital-frame-corner corner-br"></div>
    
    <div class="login-container fadeIn">
        <div class="login-promo-panel">
            <div class="promo-image-wrapper">
                <video autoplay loop muted playsinline src="/assets/videos/promo.mp4"></video>
            </div>
        </div>
        
        <div class="login-form-panel">
            <!-- FORM ĐĂNG NHẬP -->
            <form id="login-form">
                <h2>Đăng Nhập</h2>
                <p class="slogan-text">TOOL HỖ TRỢ TẤT CẢ CÁC SẢNH</p>
                
                <div class="form-group">
                    <input type="text" id="login-username" placeholder="Tên đăng nhập" required>
                </div>
                
                <div class="form-group">
                    <input type="password" id="login-password" placeholder="Mật khẩu" required>
                    <!-- Nút Mắt -->
                    <span class="toggle-password-btn" onclick="togglePasswordVisibility('login-password', this)">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.98 8.223A10.477 10.477 0 001.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.45 10.45 0 0112 4.5c4.756 0 8.773 3.162 10.065 7.498a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3m3.228 3.228l3.65 3.65m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65m0 0a3 3 0 10-4.243-4.243m4.242 4.242L9.88 9.88" /></svg>
                    </span>
                </div>
                
                <button type="submit" class="btn-primary">Đăng nhập</button>
            </form>
            
            <!-- FORM ĐĂNG KÝ -->
            <form id="register-form" style="display: none;">
                <h2>Tạo Tài Khoản</h2>
                <p class="slogan-text">TOOL HỖ TRỢ TẤT CẢ CÁC SẢNH</p>
                
                <div class="form-group">
                    <!-- Cập nhật: Thêm minlength và maxlength -->
                    <input type="text" id="register-username" placeholder="Tên đăng nhập (6-20 ký tự)" required minlength="6" maxlength="20">
                </div>
                
                <div class="form-group">
                    <!-- Cập nhật: Thêm minlength và maxlength -->
                    <input type="password" id="register-password" placeholder="Mật khẩu (6-20 ký tự)" required minlength="6" maxlength="20">
                    <span class="toggle-password-btn" onclick="togglePasswordVisibility('register-password', this)">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.98 8.223A10.477 10.477 0 001.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.45 10.45 0 0112 4.5c4.756 0 8.773 3.162 10.065 7.498a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3m3.228 3.228l3.65 3.65m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65m0 0a3 3 0 10-4.243-4.243m4.242 4.242L9.88 9.88" /></svg>
                    </span>
                </div>
                
                <div class="form-group">
                    <!-- Cập nhật: Thêm minlength và maxlength -->
                    <input type="password" id="register-password-confirm" placeholder="Nhập lại mật khẩu" required minlength="6" maxlength="20">
                    <span class="toggle-password-btn" onclick="togglePasswordVisibility('register-password-confirm', this)">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.98 8.223A10.477 10.477 0 001.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.45 10.45 0 0112 4.5c4.756 0 8.773 3.162 10.065 7.498a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3m3.228 3.228l3.65 3.65m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65m0 0a3 3 0 10-4.243-4.243m4.242 4.242L9.88 9.88" /></svg>
                    </span>
                </div>
                
                <button type="submit" class="btn-primary">Đăng ký</button>
            </form>
            
            <button id="toggle-btn" class="btn-secondary" style="margin-top: 15px;">Chưa có tài khoản? Đăng ký</button>
            <p id="message"></p>
        </div>
    </div>

    <script>
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const toggleBtn = document.getElementById('toggle-btn');
        const messageEl = document.getElementById('message');

        // Logic Chuyển đổi giữa Đăng nhập và Đăng ký
        toggleBtn.addEventListener('click', () => {
            if (loginForm.style.display === 'none') {
                loginForm.style.display = 'block';
                registerForm.style.display = 'none';
                toggleBtn.textContent = 'Chưa có tài khoản? Đăng ký';
                messageEl.textContent = ''; // Xóa thông báo cũ
            } else {
                loginForm.style.display = 'none';
                registerForm.style.display = 'block';
                toggleBtn.textContent = 'Đã có tài khoản? Đăng nhập';
                messageEl.textContent = ''; // Xóa thông báo cũ
            }
        });

        /* === LOGIC HIỆN/ẨN MẬT KHẨU === */
        const eyeOpenSVG = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>`;
        const eyeClosedSVG = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.98 8.223A10.477 10.477 0 001.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.45 10.45 0 0112 4.5c4.756 0 8.773 3.162 10.065 7.498a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3m3.228 3.228l3.65 3.65m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65m0 0a3 3 0 10-4.243-4.243m4.242 4.242L9.88 9.88" /></svg>`;

        function togglePasswordVisibility(inputId, btn) {
            const input = document.getElementById(inputId);
            if (input.type === "password") {
                input.type = "text";
                input.classList.add('password-shown');
                btn.innerHTML = eyeOpenSVG;
            } else {
                input.type = "password";
                input.classList.remove('password-shown');
                btn.innerHTML = eyeClosedSVG;
            }
        }

        // Xử lý Đăng Ký (Đã cập nhật logic kiểm tra độ dài)
        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('register-username').value;
            const password = document.getElementById('register-password').value;
            const confirmPassword = document.getElementById('register-password-confirm').value;

            let errors = [];
            
            // CẬP NHẬT: Kiểm tra độ dài 6-20 ký tự
            if (username.length < 6 || username.length > 20) {
                errors.push('Tên đăng nhập phải từ 6 đến 20 ký tự!');
            }
            
            if (password.length < 6 || password.length > 20) {
                errors.push('Mật khẩu phải từ 6 đến 20 ký tự!');
            }
            
            if (password !== confirmPassword) {
                errors.push('Mật khẩu nhập lại không khớp!');
            }

            if (errors.length > 0) {
                messageEl.textContent = errors[0];
                messageEl.className = 'error';
                return;
            }
            
            try {
                const response = await fetch('/api/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const data = await response.json();
                messageEl.textContent = data.message;
                messageEl.className = data.success ? 'success' : 'error';
                if (data.success) {
                    setTimeout(() => window.location.reload(), 1500);
                }
            } catch (err) {
                messageEl.textContent = "Lỗi kết nối máy chủ";
                messageEl.className = 'error';
            }
        });

        // Xử lý Đăng Nhập
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;
            
            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const data = await response.json();
                if (data.success) {
                    localStorage.setItem('username', username);
                    if (data.isAdmin) {
                        localStorage.setItem('adminId', data.userId);
                        localStorage.setItem('isSuperAdmin', data.isSuperAdmin); 
                    }
                    window.location.href = data.isAdmin ? '/admin.html' : '/brand-selection.html';
                } else {
                    messageEl.textContent = data.message;
                    messageEl.className = 'error';
                }
            } catch (err) {
                messageEl.textContent = "Lỗi kết nối máy chủ";
                messageEl.className = 'error';
            }
        });

        // Hiệu ứng Ma trận nền
        const canvas = document.getElementById('matrix-canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        const numbers = '0123456789';
        const fontSize = 16;
        const columns = canvas.width / fontSize;
        const drops = Array(Math.floor(columns)).fill(1);

        function draw() {
            ctx.fillStyle = 'rgba(248, 249, 250, 0.1)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = 'rgba(217, 4, 41, 0.7)';
            ctx.font = `${fontSize}px Arial`;
            for (let i = 0; i < drops.length; i++) {
                const text = numbers.charAt(Math.floor(Math.random() * numbers.length));
                ctx.fillText(text, i * fontSize, drops[i] * fontSize);
                if (drops[i] * fontSize > canvas.height && Math.random() > 0.975) {
                    drops[i] = 0;
                }
                drops[i]++;
            }
        }
        setInterval(draw, 50);
        window.addEventListener('resize', () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        });
    </script>
    <script src="/js/global.js"></script>
</body>
</html>